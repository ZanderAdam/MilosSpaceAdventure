# Workflow B: Autosave System
## Phase 1.6.2 - Mobile Enhancement

**State Machine:** ANALYZE → EXTEND_SAVE → EXTEND_DATA → IMPL_BOOT → TEST_MOBILE → COMPLETE
**Duration:** 1.5 days
**Priority:** HIGH
**Dependencies:** None (can run in parallel with Workflow A)
**Blocks:** None

---

## Goal

Support mobile 15-30 min play sessions with automatic save/resume.

---

## Current State

Phase 1 has manual save/load (SaveManager.cs). Need to make it automatic.

---

## Specification

**Auto-save triggers:**
- Every planet scanned (Phase 2+)
- Every 5 minutes of idle gameplay
- OnApplicationPause (mobile backgrounding)
- OnApplicationQuit (clean shutdown)

**Requirements:**
- Resume from last save on app reopen
- Persistent across sessions
- No "Save/Load" buttons visible to player
- Zero data loss on crash/force quit

---

## Task Breakdown

### B1: Analyze Current SaveManager (0.25d) - ANALYZE State

**Objective:** Understand existing save/load implementation

**Actions:**
- Read: `Assets/_Project/Scripts/Save/SaveManager.cs`
- Read: `Assets/_Project/Scripts/Save/SaveData.cs`
- Document current save/load flow
- Identify what data is currently saved
- Check file paths and serialization method

**Checkpoint:** ✅ Current system behavior documented

**Questions to Answer:**
- How is SaveManager instantiated (singleton/static)?
- What serialization method is used (JSON/Binary)?
- Where are save files stored (persistentDataPath)?
- What game state is currently saved?
- Are there any existing save/load events?

---

### B2: Implement Auto-Save Logic (0.5d) - EXTEND_SAVE State

**Objective:** Add automatic saving with timers and lifecycle hooks

**File to Modify:** `Assets/_Project/Scripts/Save/SaveManager.cs`

**Implementation:**

```csharp
using UnityEngine;
using System.IO;
using System;

public class SaveManager : MonoBehaviour
{
    public static SaveManager Instance { get; private set; }

    [Header("Auto-Save Settings")]
    [SerializeField] private float autoSaveInterval = 300f; // 5 minutes
    [SerializeField] private bool enableAutoSave = true;

    private string SavePath => Path.Combine(Application.persistentDataPath, "save.json");
    private float _timeSinceLastSave;

    public event Action OnSaveCompleted;
    public event Action<SaveData> OnLoadCompleted;

    private void Awake()
    {
        if (Instance != null) { Destroy(gameObject); return; }
        Instance = this;
        DontDestroyOnLoad(gameObject);
    }

    private void Update()
    {
        if (!enableAutoSave) return;

        _timeSinceLastSave += Time.deltaTime;

        if (_timeSinceLastSave >= autoSaveInterval)
        {
            AutoSave("Timed auto-save");
        }
    }

    private void OnApplicationPause(bool pauseStatus)
    {
        if (pauseStatus && enableAutoSave)
        {
            AutoSave("App paused");
        }
    }

    private void OnApplicationQuit()
    {
        if (enableAutoSave)
        {
            AutoSave("App quit");
        }
    }

    public void AutoSave(string reason)
    {
        var data = GatherSaveData();
        Save(data);
        _timeSinceLastSave = 0f;

        Debug.Log($"Auto-saved: {reason}");
    }

    private SaveData GatherSaveData()
    {
        var data = new SaveData();

        // Gather from various systems
        var ship = FindObjectOfType<PlayerShipController>();
        if (ship != null)
        {
            data.shipX = ship.transform.position.x;
            data.shipY = ship.transform.position.y;
            data.shipRotation = ship.transform.eulerAngles.z;
        }

        // TODO Phase 2+: Add scanned planets
        // TODO Phase 3+: Add rescued stuffies

        data.lastSaveTime = DateTime.Now.ToString("o");

        return data;
    }

    public void Save(SaveData data)
    {
        try
        {
            string json = JsonUtility.ToJson(data, true);
            File.WriteAllText(SavePath, json);
            OnSaveCompleted?.Invoke();
        }
        catch (Exception e)
        {
            Debug.LogError($"Save failed: {e.Message}");
        }
    }

    public SaveData Load()
    {
        if (!File.Exists(SavePath))
        {
            Debug.Log("No save file found");
            return null;
        }

        try
        {
            string json = File.ReadAllText(SavePath);
            var data = JsonUtility.FromJson<SaveData>(json);
            OnLoadCompleted?.Invoke(data);
            return data;
        }
        catch (Exception e)
        {
            Debug.LogError($"Load failed: {e.Message}");
            return null;
        }
    }

    public void LoadAndApply()
    {
        var data = Load();
        if (data != null)
        {
            ApplySaveData(data);
        }
    }

    private void ApplySaveData(SaveData data)
    {
        var ship = FindObjectOfType<PlayerShipController>();
        if (ship != null)
        {
            ship.transform.position = new Vector3(data.shipX, data.shipY, 0);
            ship.transform.rotation = Quaternion.Euler(0, 0, data.shipRotation);
        }

        Debug.Log($"Loaded save from: {data.lastSaveTime}");
    }

    public void DeleteSave()
    {
        if (File.Exists(SavePath)) File.Delete(SavePath);
    }

    public bool HasSaveData()
    {
        return File.Exists(SavePath);
    }
}
```

**Checkpoint:** ✅ Auto-save triggers every 5 minutes

**Testing:**
- Add debug log to verify timer triggers
- Manually call `OnApplicationPause(true)` to test hook
- Verify save file created at expected path

---

### B3: Extend SaveData (0.25d) - EXTEND_DATA State

**Objective:** Add timestamp and ship state fields

**File to Modify:** `Assets/_Project/Scripts/Save/SaveData.cs`

**Implementation:**

```csharp
[System.Serializable]
public class SaveData
{
    public string currentSystemId;
    public float shipX;
    public float shipY;
    public float shipRotation;

    public string lastSaveTime; // ISO 8601 format

    // Phase 2+
    // public List<string> scannedPlanetIds;

    // Phase 3+
    // public List<string> rescuedStuffyIds;
    // public List<string> unlockedAbilities;
}
```

**Checkpoint:** ✅ SaveData serializes/deserializes correctly

**Testing:**
- Create SaveData instance
- Populate with test values
- Serialize to JSON: `JsonUtility.ToJson(data, true)`
- Deserialize from JSON: `JsonUtility.FromJson<SaveData>(json)`
- Verify all fields preserve values

---

### B4: Create BootController (0.25d) - IMPL_BOOT State

**Objective:** Auto-load save on app startup

**File to Create:** `Assets/_Project/Scripts/Save/BootController.cs`

**Implementation:**

```csharp
using UnityEngine;

public class BootController : MonoBehaviour
{
    private void Start()
    {
        // Auto-load on startup
        if (SaveManager.Instance.HasSaveData())
        {
            SaveManager.Instance.LoadAndApply();
            Debug.Log("Resumed from last session");
        }
        else
        {
            Debug.Log("New game started");
        }
    }
}
```

**Setup:**
1. Create empty GameObject in startup scene
2. Name it "BootController"
3. Add BootController component
4. Ensure it runs after SaveManager is initialized

**Checkpoint:** ✅ Boot sequence loads save data

**Testing:**
- Play game → move ship → auto-save triggered → quit
- Restart Unity → play game → verify ship position restored

---

### B5: Mobile Testing (0.25d) - TEST_MOBILE State

**Objective:** Validate auto-save on mobile lifecycle events

**Test Cases:**

#### 1. OnApplicationPause (Background App)

**Unity Editor Simulation:**
```csharp
// Add this test button to a debug UI or script
if (GUILayout.Button("Simulate App Pause"))
{
    FindObjectOfType<SaveManager>().OnApplicationPause(true);
}
```

**Or use:** Unity Editor → File → Pause (though this pauses game time)

**Expected:**
- Auto-save triggers immediately
- Save file written to disk
- Console shows "Auto-saved: App paused"

**Mobile Device Test (if available):**
- Play game → move ship
- Press home button (background app)
- Check device logs → verify auto-save triggered
- Reopen app → verify ship position restored

#### 2. OnApplicationQuit (Force Close)

**Unity Editor Simulation:**
- Play game → move ship → stop play mode
- Check save file exists: `Application.persistentDataPath/save.json`
- Restart play mode → verify ship restored

**Mobile Device Test (if available):**
- Play game → move ship
- Force close app (swipe away)
- Reopen app → verify ship position restored

#### 3. Timed Auto-Save

**Test:**
- Play game for 5+ minutes
- Watch console for "Auto-saved: Timed auto-save"
- Verify triggers every 5 minutes

**Adjustment:**
- For testing, temporarily set `autoSaveInterval = 10f` (10 seconds)
- Test, then restore to 300f (5 minutes)

#### 4. Save Persistence

**Test:**
- Play game → auto-save triggers
- Quit Unity completely
- Restart Unity → play game
- Verify ship position restored from save file

#### 5. No Data Loss on Crash

**Simulation:**
- Play game → auto-save triggers (verify file written)
- Force quit Unity (Task Manager/Activity Monitor)
- Restart Unity → play game
- Verify last auto-save restored successfully

**Quality Gate:** ✅ No data loss on crash/background

**Checkpoint:** ✅ All mobile lifecycle tests pass

**Transition to:** COMPLETE State

---

## Circuit Breaker Implementation

**Autosave Circuit Breaker (Optional Enhancement):**

Add to SaveManager.cs to handle repeated failures:

```csharp
private int _consecutiveFailures = 0;
private const int MAX_FAILURES = 3;

public void Save(SaveData data)
{
    try
    {
        string json = JsonUtility.ToJson(data, true);
        File.WriteAllText(SavePath, json);
        OnSaveCompleted?.Invoke();
        _consecutiveFailures = 0; // Reset on success
    }
    catch (Exception e)
    {
        _consecutiveFailures++;
        Debug.LogError($"Save failed ({_consecutiveFailures}/{MAX_FAILURES}): {e.Message}");

        if (_consecutiveFailures >= MAX_FAILURES)
        {
            enableAutoSave = false;
            Debug.LogError("Auto-save disabled after 3 consecutive failures!");
            // TODO: Notify player via UI
        }
    }
}
```

---

## Enhanced Save Security (Optional)

### Atomic Writes (Prevent Corruption)

```csharp
public void Save(SaveData data)
{
    try
    {
        string json = JsonUtility.ToJson(data, true);

        // Write to temp file first
        string tempPath = SavePath + ".tmp";
        File.WriteAllText(tempPath, json);

        // Backup existing save
        if (File.Exists(SavePath))
        {
            File.Copy(SavePath, SavePath + ".bak", true);
        }

        // Atomic rename
        File.Move(tempPath, SavePath, true);

        OnSaveCompleted?.Invoke();
    }
    catch (Exception e)
    {
        Debug.LogError($"Save failed: {e.Message}");
    }
}
```

### CRC Validation

```csharp
public SaveData Load()
{
    if (!File.Exists(SavePath))
    {
        Debug.Log("No save file found");
        return null;
    }

    try
    {
        string json = File.ReadAllText(SavePath);
        var data = JsonUtility.FromJson<SaveData>(json);

        // Validate data integrity
        if (string.IsNullOrEmpty(data.lastSaveTime))
        {
            throw new Exception("Corrupted save file (missing timestamp)");
        }

        OnLoadCompleted?.Invoke(data);
        return data;
    }
    catch (Exception e)
    {
        Debug.LogError($"Load failed: {e.Message}");

        // Try backup if exists
        if (File.Exists(SavePath + ".bak"))
        {
            Debug.Log("Attempting to load backup save...");
            string backupJson = File.ReadAllText(SavePath + ".bak");
            return JsonUtility.FromJson<SaveData>(backupJson);
        }

        return null;
    }
}
```

---

## Integration Points

### With Workflow A (Gravity Lock)
- **Enhancement:** Add `lockedPlanetId` to SaveData
- **Implementation:**
  ```csharp
  // In SaveData.cs
  public string lockedPlanetId;

  // In SaveManager.GatherSaveData()
  var gravityLock = ship.GetComponent<GravityLockSystem>();
  if (gravityLock != null && gravityLock.IsLocked)
  {
      data.lockedPlanetId = gravityLock.LockedPlanet.BodyId;
  }

  // In SaveManager.ApplySaveData()
  if (!string.IsNullOrEmpty(data.lockedPlanetId))
  {
      // Re-establish lock on load
      var planet = FindPlanetById(data.lockedPlanetId);
      if (planet != null)
      {
          gravityLock.LockToPlanet(planet);
      }
  }
  ```

---

## Completion Criteria

- ✅ Auto-saves every 5 min
- ✅ Saves on app pause/quit
- ✅ Resumes correctly on restart
- ✅ Persistent across sessions
- ✅ No data loss on crash (tested)
- ✅ Manual Save/Load UI removed or hidden
- ✅ All test cases pass

---

## Files Modified/Created

**Created (1):**
- `Assets/_Project/Scripts/Save/BootController.cs`

**Modified (2):**
- `Assets/_Project/Scripts/Save/SaveManager.cs`
- `Assets/_Project/Scripts/Save/SaveData.cs`

---

## State Transitions

```
NOT_STARTED
    ↓
[B1] ANALYZE (understand current save system)
    ↓
[B2] EXTEND_SAVE (add auto-save logic)
    ↓
[B3] EXTEND_DATA (add timestamp & ship state)
    ↓
[B4] IMPL_BOOT (create auto-load controller)
    ↓
[B5] TEST_MOBILE (validate lifecycle events)
    ↓
COMPLETE (ready for integration)
```

---

## Risk Mitigation

### Risk: Autosave File Corruption
**Symptom:** Save file unreadable, game crashes on load

**Mitigation:**
- Use atomic writes (temp file → rename)
- Add CRC/checksum validation
- Keep backup of previous save (`.bak` file)
- Validate SaveData fields on load

**Fallback:**
- Load from backup if main save corrupt
- Delete corrupt save and start fresh (better than crash)
- Log error for debugging

### Risk: Excessive Auto-Saves (Performance)
**Symptom:** Frequent disk writes cause stuttering

**Mitigation:**
- Set reasonable interval (5 min minimum)
- Use async file I/O if needed:
  ```csharp
  await File.WriteAllTextAsync(SavePath, json);
  ```
- Don't save on every frame update

---

## Testing Checklist

- [ ] Auto-save triggers every 5 minutes
- [ ] OnApplicationPause triggers save (Editor simulation)
- [ ] OnApplicationQuit triggers save
- [ ] Save file persists across Unity restarts
- [ ] Load on startup restores ship position
- [ ] Save file located at correct path (persistentDataPath)
- [ ] SaveData serializes/deserializes correctly
- [ ] Timestamp saved in ISO 8601 format
- [ ] No errors in console during save/load
- [ ] Manual Save/Load buttons removed/hidden
- [ ] (Optional) Mobile device testing confirms functionality

---

## Next Steps After Completion

1. **Add to Save Data:** Consider adding more game state (current system, player stats)
2. **UI Indicator:** Show "Saving..." icon briefly when auto-save triggers
3. **Settings Toggle:** Allow player to disable auto-save (save on quit only)
4. **Cloud Sync:** Consider cloud save sync for future (Google Play/iCloud)
5. **Save Slots:** Support multiple save files for different players
