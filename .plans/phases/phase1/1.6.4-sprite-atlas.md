# Workflow D: Sprite Atlas
## Phase 1.6.4 - Performance Optimization

**State Machine:** CREATE → CONFIGURE → POPULATE → INTEGRATE → VALIDATE → COMPLETE
**Duration:** 0.5 days
**Priority:** MEDIUM
**Dependencies:** None (can run in parallel with A, B)
**Blocks:** None

---

## Goal

Reduce draw calls from 100+ to ~5 for 30 FPS mobile target.

---

## Specification

- Create `CelestialsAtlas.spriteatlas`
- Include: Sun, all planets, moons, ship, particles
- Update StarSystemLoader to use atlas sprites
- Enable atlas in build settings
- Target: <10 draw calls (from 100+)

---

## Task Breakdown

### D1: Create Sprite Atlas (0.1d) - CREATE State

**Objective:** Create atlas asset in project

**Steps:**
1. Right-click in Unity Project window
2. Navigate to: `Create → 2D → Sprite Atlas`
3. Name: `CelestialsAtlas`
4. Move to: `Assets/_Project/Art/Atlases/CelestialsAtlas.spriteatlas`

**Create Atlases Folder:**
```
Assets/
└── _Project/
    └── Art/
        └── Atlases/  ← Create this folder
            └── CelestialsAtlas.spriteatlas
```

**Checkpoint:** ✅ Atlas asset exists

**Verification:**
- Atlas asset visible in Project window
- Located in correct folder
- Inspector shows Sprite Atlas properties

---

### D2: Configure Atlas Settings (0.1d) - CONFIGURE State

**Objective:** Set platform-specific compression settings

**Inspector Settings:**

#### General Settings
```
Type: Master
Include in Build: ✅ CHECKED (critical!)
Allow Rotation: ✅ CHECKED (better packing)
Tight Packing: ✅ CHECKED (reduces atlas size)
Padding: 2 pixels
Read/Write Enabled: ❌ UNCHECKED (save memory)
Generate Mip Maps: ❌ UNCHECKED (2D sprites don't need)
```

#### Platform Settings - Android
```
Max Texture Size: 2048
Resize Algorithm: Bilinear
Format: RGBA Compressed ETC2 8 bits
Compression: Normal Quality
Use Crunch Compression: ❌ UNCHECKED (slower loading)
```

#### Platform Settings - iOS
```
Max Texture Size: 2048
Resize Algorithm: Bilinear
Format: RGBA Compressed PVRTC 4 bits
Compression: Normal Quality
```

#### Platform Settings - Standalone (Windows/Mac/Linux)
```
Max Texture Size: 2048
Resize Algorithm: Bilinear
Format: RGBA Compressed DXT5
Compression: Normal Quality
```

**Checkpoint:** ✅ Platform settings configured

**Notes:**
- Max size 2048x2048 supports most mobile devices
- PVRTC (iOS) and ETC2 (Android) are hardware-compressed formats
- Adjust size if atlas exceeds 2048 (split into multiple atlases)

---

### D3: Populate Atlas (0.1d) - POPULATE State

**Objective:** Add all celestial sprites to atlas

**Objects for Packing:**

Drag these folders into "Objects for Packing" section:
1. `Assets/_Project/Content/StarSystems/Sol/` (all celestial sprites)
2. `Assets/_Project/Art/Ship/` (ship sprite)
3. `Assets/_Project/Art/Particles/` (particle textures)

**Or Add Individual Sprites:**
- Sun sprite
- All planet sprites (Mercury, Venus, Earth, Mars, Jupiter, Saturn, Uranus, Neptune)
- Moon sprites
- Ship sprite(s)
- Particle textures (thrust, glow, scan effects)

**Pack Preview:**
1. Select CelestialsAtlas in Project
2. Click "Pack Preview" button at bottom of Inspector
3. Wait for packing to complete
4. Verify all sprites visible in preview window

**Checkpoint:** ✅ All sprites packed, atlas size < 2048x2048

**Troubleshooting:**

**If atlas > 2048x2048:**
- Option 1: Reduce individual sprite sizes
- Option 2: Split into multiple atlases:
  - `CelestialsAtlas` (planets/moons)
  - `ShipAtlas` (ship/particles)

**If sprites missing from preview:**
- Verify folders dragged into "Objects for Packing"
- Check sprite import settings (Sprite Mode: Single)
- Ensure sprites not in Resources folder (atlas can't pack Resources)

---

### D4: Update StarSystemLoader (0.15d) - INTEGRATE State

**Objective:** Modify loader to use atlas sprites

**File to Modify:** `Assets/_Project/Scripts/StarSystem/StarSystemLoader.cs`

**Add Atlas Reference:**

```csharp
using UnityEngine;
using UnityEngine.U2D; // Required for SpriteAtlas

public class StarSystemLoader : MonoBehaviour
{
    [Header("Sprite Atlas")]
    [SerializeField] private SpriteAtlas celestialsAtlas;

    // ... existing code ...
}
```

**Update LoadSpriteAsync:**

**Before (StreamingAssets Only):**
```csharp
private IEnumerator LoadSpriteAsync(string systemId, string filename)
{
    if (_loadedSprites.ContainsKey(filename))
        yield break;

    string path = $"{Application.streamingAssetsPath}/Systems/{systemId}/{filename}";
    // ... load from StreamingAssets ...
}
```

**After (Atlas First, StreamingAssets Fallback):**
```csharp
private IEnumerator LoadSpriteAsync(string systemId, string filename)
{
    if (_loadedSprites.ContainsKey(filename))
        yield break;

    // Try atlas first
    if (celestialsAtlas != null)
    {
        string spriteName = Path.GetFileNameWithoutExtension(filename);
        Sprite sprite = celestialsAtlas.GetSprite(spriteName);

        if (sprite != null)
        {
            _loadedSprites[filename] = sprite;
            Debug.Log($"Loaded sprite from atlas: {spriteName}");
            yield break; // Found in atlas, done
        }
        else
        {
            Debug.LogWarning($"Sprite not found in atlas: {spriteName}, falling back to StreamingAssets");
        }
    }

    // Fallback: Load from StreamingAssets (existing code)
    string path = $"{Application.streamingAssetsPath}/Systems/{systemId}/{filename}";

    // ... rest of existing StreamingAssets loading code ...
}
```

**Assign Atlas in Inspector:**
1. Select StarSystemLoader GameObject in scene
2. Find "Celestials Atlas" field
3. Drag `CelestialsAtlas` asset into field

**Checkpoint:** ✅ Sprites load from atlas

**Testing:**
- Play game → check console for "Loaded sprite from atlas" messages
- Verify all celestial bodies render correctly
- Confirm no "Sprite not found" warnings

---

### D5: Performance Validation (0.15d) - VALIDATE State

**Objective:** Measure draw call reduction and FPS improvement

**Quality Gates:**
- ✅ Draw calls < 10 (from 100+)
- ✅ 30 FPS in Unity Editor (60 FPS if not simulating mobile)

#### Step 1: Enable Project Settings

**Sprite Packer Mode:**
1. Edit → Project Settings → Editor
2. Find "Sprite Packer"
3. Set Mode: **"Always Enabled"** (critical!)
4. Restart Unity if needed

**Why:** This enables sprite atlas packing in builds. Without this, atlases won't work!

#### Step 2: Baseline Measurement (Before Atlas)

**Temporarily disable atlas:**
1. Select StarSystemLoader in scene
2. Clear "Celestials Atlas" field (set to None)
3. Play game

**Measure:**
1. Game View → Stats button (top right)
2. Note:
   - **Batches:** ~100-150 (one per sprite)
   - **SetPass calls:** ~100-150
   - **FPS:** ~20-25 (if simulating mobile)

#### Step 3: After Atlas Measurement

**Re-enable atlas:**
1. Assign CelestialsAtlas to StarSystemLoader
2. Play game

**Measure:**
1. Game View → Stats
2. Note:
   - **Batches:** ~5-10 (batched by atlas) ✅
   - **SetPass calls:** ~5-10
   - **FPS:** ~30+ (mobile sim) or 60+ (desktop)

#### Step 4: Unity Profiler Validation

**Rendering Stats:**
1. Window → Analysis → Profiler
2. Select "Rendering" module
3. Play game for 1 minute
4. Check "SetPass Calls" graph

**Before Atlas:**
```
SetPass Calls: 100-150 per frame
Batches: 100-150 per frame
```

**After Atlas:**
```
SetPass Calls: 5-10 per frame ✅
Batches: 5-10 per frame ✅
```

#### Step 5: Build Size Check

**Atlas Impact on Build:**
1. Build game with atlas enabled
2. Note build size
3. Expected increase: <5 MB (compressed textures)

**Why Small?** Compressed formats (ETC2/PVRTC) are very efficient

**Checkpoint:** ✅ Performance targets met

**Documentation:**
```
Performance Results:
- Draw Calls: 120 → 7 (94% reduction) ✅
- SetPass Calls: 125 → 8 (94% reduction) ✅
- FPS (Editor): 55-60 → 60 (stable) ✅
- FPS (Mobile Sim): 22-28 → 30-35 ✅
- Build Size: +3.2 MB (atlas textures)
```

**Transition to:** COMPLETE State

---

## Advanced Atlas Configuration

### Multiple Atlases (If Single Atlas Too Large)

**If CelestialsAtlas > 2048x2048:**

Create separate atlases:

**1. PlanetsAtlas.spriteatlas**
- Contains: Sun, planets, moons
- Max Size: 2048x2048

**2. ShipAndParticlesAtlas.spriteatlas**
- Contains: Ship sprites, particle textures
- Max Size: 1024x1024

**Update StarSystemLoader:**
```csharp
[SerializeField] private SpriteAtlas planetsAtlas;
[SerializeField] private SpriteAtlas shipAndParticlesAtlas;

private IEnumerator LoadSpriteAsync(string systemId, string filename)
{
    // Try planets atlas
    if (planetsAtlas != null)
    {
        Sprite sprite = planetsAtlas.GetSprite(spriteName);
        if (sprite != null) { /* ... */ }
    }

    // Try ship/particles atlas
    if (shipAndParticlesAtlas != null)
    {
        Sprite sprite = shipAndParticlesAtlas.GetSprite(spriteName);
        if (sprite != null) { /* ... */ }
    }

    // Fallback to StreamingAssets
    // ...
}
```

### Variant Atlases (For Different Quality Levels)

**Master Atlas:**
- High quality (RGBA32 or RGBA Compressed)
- For desktop/high-end mobile

**Variant Atlas:**
- Lower quality (RGB Compressed, smaller size)
- For low-end mobile

**Implementation:**
1. Create master atlas as normal
2. Right-click master → Create → Sprite Atlas Variant
3. Set variant to use more aggressive compression
4. Unity automatically uses variant on lower-end devices

---

## Integration Points

### With All Workflows

**File:** `StarSystemLoader.cs`

**Issue:** Atlas must load all sprites used by all features

**Validation:**
- Workflow A: Verify gravity lock indicator sprite in atlas (if sprite-based)
- Workflow B: No direct impact (save system)
- Workflow C: Verify particle textures in atlas
- All: Check console for "missing sprite" errors

**Testing:**
- Play through all features
- Verify all sprites render correctly
- Confirm draw calls remain <10 throughout gameplay

---

## Completion Criteria

- ✅ Atlas packs all celestial sprites
- ✅ Sprites load from atlas (not StreamingAssets)
- ✅ Draw calls reduced to < 10
- ✅ Visual quality unchanged
- ✅ FPS target achieved (30 FPS mobile sim, 60 FPS desktop)
- ✅ Build size impact minimal (< 5 MB increase)
- ✅ Sprite Packer enabled in Project Settings

---

## Files Modified/Created

**Created (1):**
- `Assets/_Project/Art/Atlases/CelestialsAtlas.spriteatlas`

**Modified (1):**
- `Assets/_Project/Scripts/StarSystem/StarSystemLoader.cs`

**Project Settings:**
- Editor → Sprite Packer Mode: "Always Enabled"

---

## State Transitions

```
NOT_STARTED
    ↓
[D1] CREATE (create sprite atlas asset)
    ↓
[D2] CONFIGURE (set platform compression)
    ↓
[D3] POPULATE (add sprites to atlas)
    ↓
[D4] INTEGRATE (update StarSystemLoader)
    ↓
[D5] VALIDATE (measure draw call reduction)
    ↓
COMPLETE (draw calls <10 achieved)
```

---

## Risk Mitigation

### Risk: Sprite Atlas Doesn't Reduce Draw Calls
**Symptom:** Draw calls still high (>50) despite atlas

**Diagnosis:**
1. Check Sprite Packer Mode: Edit → Project Settings → Editor
   - **Must be "Always Enabled"**
2. Check atlas Include in Build: ✅ Must be checked
3. Verify sprites loading from atlas: Check console logs
4. Check dynamic batching: Edit → Project Settings → Player → Other Settings
   - Dynamic Batching: ✅ Enabled (for 2D)

**Mitigation:**
- Disable dynamic batching (can conflict with atlases)
- Ensure all sprites use same material
- Check sprites not in Resources folder

**Fallback:**
- Use smaller atlases per system (Sol, Alpha Centauri, etc.)
- Profile to find non-batching sprites
- Consider switching to SpriteRenderer batching hints

### Risk: Atlas Exceeds 2048x2048
**Symptom:** Atlas won't pack, or quality degraded

**Solution:**
- Split into multiple atlases (Planets, Ships, Particles)
- Reduce individual sprite sizes (compress before import)
- Use Tight Packing + Allow Rotation for better fit

### Risk: Missing Sprites After Atlas
**Symptom:** Some sprites don't render, white squares appear

**Diagnosis:**
1. Check Pack Preview → are all sprites visible?
2. Check console → "Sprite not found in atlas" warnings
3. Verify sprite names match (case-sensitive)

**Solution:**
- Re-pack atlas (Pack Preview button)
- Check sprite import settings
- Ensure sprites added to "Objects for Packing"

---

## Testing Checklist

- [ ] Sprite atlas asset created
- [ ] Platform compression settings configured
- [ ] All celestial sprites added to atlas
- [ ] Pack Preview shows all sprites
- [ ] Atlas size < 2048x2048
- [ ] StarSystemLoader updated with atlas reference
- [ ] Sprites load from atlas (console confirms)
- [ ] Draw calls < 10 (Stats window)
- [ ] SetPass calls < 10 (Profiler)
- [ ] FPS target achieved (30+ mobile, 60 desktop)
- [ ] Visual quality unchanged (no artifacts)
- [ ] Sprite Packer Mode: "Always Enabled"
- [ ] Build size increase < 5 MB

---

## Performance Targets

| Metric | Before | After | Improvement | Status |
|--------|--------|-------|-------------|--------|
| Draw Calls | 100-150 | <10 | 90%+ reduction | ✅ |
| SetPass Calls | 100-150 | <10 | 90%+ reduction | ✅ |
| Texture Memory | ~50 MB | ~10 MB | 80% reduction | ✅ |
| FPS (Mobile) | 20-25 | 30+ | 20%+ increase | ✅ |
| FPS (Desktop) | 55-60 | 60 (stable) | Stable | ✅ |
| Build Size | Baseline | +3-5 MB | Acceptable | ✅ |

---

## Next Steps After Completion

1. **Monitor Production:** Track draw calls in analytics
2. **Additional Atlases:** Create atlases for Phase 2+ content
3. **LOD Variants:** Create lower-res atlas variants for low-end devices
4. **Profiling:** Profile on actual mobile devices
5. **Optimization:** Consider texture compression quality tweaks
6. **Documentation:** Document atlas naming conventions for team
